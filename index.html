<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Will's Precision Layer Prints</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #9ca3af;
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-500 min-h-screen flex flex-col items-center">

    <!-- Header -->
    <header class="w-full bg-black text-white shadow-lg z-50">
        <nav class="container mx-auto p-4 flex justify-between items-center flex-wrap">
            <h1 class="text-2xl font-bold">Will's Precision Layer Prints</h1>
            <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                <button id="cart-button" class="relative text-gray-300 hover:text-white transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2zm-9.83-3.25l3.52-6.5c.02-.04.05-.07.07-.1L10.7 7H14.1c.75 0 1.41.38 1.78 1.02L20.2 17H8.25c-.2 0-.4-.1-.5-.25-.13-.15-.22-.32-.22-.55l-.52-1.25zM17 15.5l-3.32-6h-3.95l-3.52 6h10.79z"/>
                    </svg>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <div id="auth-buttons" class="flex items-center space-x-2">
                    <button id="login-button" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                        Sign In with Google
                    </button>
                </div>
                <div id="user-profile" class="hidden relative">
                    <button id="user-profile-button" class="flex items-center space-x-2 text-white">
                        <img id="user-avatar" class="w-10 h-10 rounded-full border-2 border-gray-400" src="https://placehold.co/40x40" alt="User Avatar">
                        <span id="user-name" class="hidden lg:inline font-medium"></span>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-2 z-50">
                        <a href="#" id="view-orders-link" class="block px-4 py-2 text-gray-800 hover:bg-gray-200">My Orders</a>
                        <a href="#" id="signout-link" class="block px-4 py-2 text-red-600 hover:bg-gray-200">Sign Out</a>
                    </div>
                </div>
                <button id="admin-button" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">Admin</button>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto p-4 flex-grow w-full">
        <!-- Products View -->
        <section id="products-view" class="view">
            <h2 class="text-3xl font-bold text-center text-white mb-8">Products</h2>
            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                <!-- Products will be dynamically inserted here -->
            </div>
        </section>

        <!-- Admin View -->
        <section id="admin-view" class="view hidden">
            <h2 class="text-3xl font-bold text-center text-white mb-8">Admin Panel</h2>
            <div class="bg-gray-700 p-6 rounded-lg shadow-lg max-w-xl mx-auto">
                <h3 class="text-2xl text-white font-semibold mb-4">Add New Product</h3>
                <form id="add-product-form" class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-300">Product Name</label>
                        <input type="text" id="product-name" name="name" required class="mt-1 block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="product-description" class="block text-sm font-medium text-gray-300">Description</label>
                        <textarea id="product-description" name="description" required rows="3" class="mt-1 block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label for="product-price" class="block text-sm font-medium text-gray-300">Price</label>
                        <input type="number" id="product-price" name="price" required step="0.01" class="mt-1 block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="product-image" class="block text-sm font-medium text-gray-300">Image URL</label>
                        <input type="text" id="product-image" name="image" required class="mt-1 block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="product-colors" class="block text-sm font-medium text-gray-300">Colors (comma-separated)</label>
                        <input type="text" id="product-colors" name="colors" class="mt-1 block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="product-sizes" class="block text-sm font-medium text-gray-300">Sizes (comma-separated)</label>
                        <input type="text" id="product-sizes" name="sizes" class="mt-1 block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                    </div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                        Add Product
                    </button>
                </form>
            </div>
            <div class="mt-8">
                <h3 class="text-2xl text-white font-semibold mb-4 text-center">All Orders</h3>
                <div id="all-orders-list" class="space-y-4">
                    <!-- All orders will be dynamically inserted here -->
                </div>
            </div>
        </section>

        <!-- My Orders View -->
        <section id="orders-view" class="view hidden">
            <h2 class="text-3xl font-bold text-center text-white mb-8">My Orders</h2>
            <div id="my-orders-list" class="space-y-4">
                <!-- My orders will be dynamically inserted here -->
            </div>
        </section>
    </main>

    <!-- Modals -->

    <!-- Cart Modal -->
    <div id="cart-modal" class="hidden fixed inset-0 z-[100] modal-bg flex items-center justify-center p-4">
        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-lg w-full max-w-lg relative">
            <button id="close-modal-button" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 class="text-2xl font-bold mb-4">Your Cart</h3>
            <div id="cart-items" class="max-h-64 overflow-y-auto mb-4 space-y-4">
                <!-- Cart items will be dynamically inserted here -->
            </div>
            <div id="cart-summary" class="border-t border-gray-700 pt-4">
                <div class="flex justify-between items-center text-xl font-bold">
                    <span>Total:</span>
                    <span id="cart-total-price">$0.00</span>
                </div>
                <button id="checkout-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-4 transition-colors duration-200">
                    Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="hidden fixed inset-0 z-[100] modal-bg flex items-center justify-center p-4">
        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-lg w-full max-w-lg relative">
            <button id="close-checkout-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 class="text-2xl font-bold mb-4">Checkout</h3>
            <form id="checkout-form" class="space-y-4">
                <div>
                    <label for="checkout-name" class="block text-sm font-medium text-gray-300">Full Name</label>
                    <input type="text" id="checkout-name" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div>
                    <label for="checkout-email" class="block text-sm font-medium text-gray-300">Email Address</label>
                    <input type="email" id="checkout-email" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div>
                    <label for="checkout-address" class="block text-sm font-medium text-gray-300">Shipping Address</label>
                    <input type="text" id="checkout-address" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <label for="checkout-country" class="block text-sm font-medium text-gray-300">Country</label>
                        <input type="text" id="checkout-country" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                    </div>
                    <div class="flex-1">
                        <label for="checkout-state" class="block text-sm font-medium text-gray-300">State/Province</label>
                        <input type="text" id="checkout-state" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                    </div>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mt-4 transition-colors duration-200">
                    Confirm Purchase
                </button>
            </form>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="hidden fixed inset-0 z-[100] modal-bg flex items-center justify-center p-4">
        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-lg w-full max-w-sm relative text-center">
            <button id="close-message-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 id="message-title" class="text-xl font-bold mb-2"></h3>
            <p id="message-text" class="text-gray-300 mb-4"></p>
            <button id="acknowledge-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                OK
            </button>
        </div>
    </div>

    <!-- Add to Cart Modal -->
    <div id="add-to-cart-modal" class="hidden fixed inset-0 z-[100] modal-bg flex items-center justify-center p-4">
        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-lg w-full max-w-sm relative text-center">
            <h3 class="text-xl font-bold mb-2">Item Added to Cart!</h3>
            <p class="text-gray-300 mb-4">Your item has been successfully added to your cart.</p>
            <button id="close-options-modal" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                Continue Shopping
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration and Initialization
        const firebaseConfig = JSON.parse('{"projectId":"will-s-precision-layer-prints"}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Canvas-specific variables
        const app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Global state
        let products = [];
        let cart = [];
        let userId = null;

        // DOM elements
        const productList = document.getElementById('product-list');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalPriceElement = document.getElementById('cart-total-price');
        const cartCountElement = document.getElementById('cart-count');
        const cartModal = document.getElementById('cart-modal');
        const checkoutModal = document.getElementById('checkout-modal');
        const checkoutForm = document.getElementById('checkout-form');
        const loginButton = document.getElementById('login-button');
        const userProfile = document.getElementById('user-profile');
        const authButtons = document.getElementById('auth-buttons');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const signoutLink = document.getElementById('signout-link');
        const viewOrdersLink = document.getElementById('view-orders-link');
        const profileDropdown = document.getElementById('profile-dropdown');
        const userProfileButton = document.getElementById('user-profile-button');
        const adminButton = document.getElementById('admin-button');
        const adminView = document.getElementById('admin-view');
        const addProductForm = document.getElementById('add-product-form');
        const myOrdersList = document.getElementById('my-orders-list');
        const allOrdersList = document.getElementById('all-orders-list');
        const messageModal = document.getElementById('message-modal');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const acknowledgeButton = document.getElementById('acknowledge-button');
        const addToCartModal = document.getElementById('add-to-cart-modal');

        // Functions for Modal Control
        window.showMessageModal = (text, title = 'Notification') => {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messageModal.classList.remove('hidden');
        };

        window.closeMessageModal = () => {
            messageModal.classList.add('hidden');
        };

        window.showView = (viewId) => {
            const views = document.querySelectorAll('.view');
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        };

        const openCartModal = () => cartModal.classList.remove('hidden');
        const closeCartModal = () => cartModal.classList.add('hidden');

        const openCheckoutModal = () => {
            closeCartModal();
            checkoutModal.classList.remove('hidden');
        };
        const closeCheckoutModal = () => checkoutModal.classList.add('hidden');

        window.showAddToCartModal = () => {
            addToCartModal.classList.remove('hidden');
        };
        window.closeAddToCartModal = () => {
            addToCartModal.classList.add('hidden');
        };

        // Utility function for price formatting
        const formatPrice = (price) => `$${price.toFixed(2)}`;

        // Render functions
        const renderProducts = () => {
            productList.innerHTML = '';
            products.forEach(product => {
                const productCard = `
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col items-center text-white">
                        <img src="${product.image}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/222222/FFFFFF?text=No+Image'" alt="${product.name}" class="w-full h-48 object-cover rounded-md mb-4">
                        <h3 class="text-xl font-semibold mb-2 text-center">${product.name}</h3>
                        <p class="text-gray-400 text-sm text-center flex-grow mb-4">${product.description}</p>
                        <p class="text-2xl font-bold mb-4">${formatPrice(product.price)}</p>
                        <button onclick="window.addToCart('${product.id}')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                            Add to Cart
                        </button>
                    </div>
                `;
                productList.innerHTML += productCard;
            });
        };

        const renderCart = () => {
            cartItemsContainer.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-400">Your cart is empty.</p>';
            } else {
                cart.forEach(item => {
                    const cartItem = `
                        <div class="flex items-center space-x-4">
                            <img src="${item.image}" onerror="this.onerror=null;this.src='https://placehold.co/64x64/222222/FFFFFF?text=No+Image'" alt="${item.name}" class="w-16 h-16 object-cover rounded-md">
                            <div class="flex-grow">
                                <h4 class="font-medium">${item.name}</h4>
                                <p class="text-gray-400">${formatPrice(item.price)} x ${item.quantity}</p>
                            </div>
                            <button onclick="window.removeFromCart('${item.id}')" class="text-red-500 hover:text-red-400 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-1 12H6L5 7m5 0V5a1 1 0 011-1h2a1 1 0 011 1v2m-6 0h6"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    cartItemsContainer.innerHTML += cartItem;
                    total += item.price * item.quantity;
                });
            }
            cartTotalPriceElement.textContent = formatPrice(total);
            cartCountElement.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
        };

        const renderOrders = (orders, container) => {
            container.innerHTML = '';
            if (orders.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">No orders found.</p>';
            } else {
                orders.forEach(order => {
                    const orderItem = `
                        <div class="bg-gray-700 p-4 rounded-lg shadow-md text-white">
                            <p class="font-bold">Order ID: ${order.id}</p>
                            <p class="text-gray-300">Total: ${formatPrice(order.total)}</p>
                            <p class="text-gray-300">Status: <span class="font-semibold">${order.status}</span></p>
                            <ul class="list-disc list-inside mt-2 text-sm text-gray-400">
                                ${order.items.map(item => `<li>${item.name} (x${item.quantity}) - ${formatPrice(item.price * item.quantity)}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    container.innerHTML += orderItem;
                });
            }
        };

        // Firebase Auth
        const provider = new GoogleAuthProvider();

        const signInWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error during sign-in:", error);
                window.showMessageModal("Failed to sign in. Please try again.");
            }
        };

        const handleSignOut = async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error during sign-out:", error);
                window.showMessageModal("Failed to sign out. Please try again.");
            }
        };

        // Firestore Operations
        const fetchProducts = () => {
            const productsCollectionRef = collection(db, 'artifacts', app_id, 'public', 'data', 'products');
            onSnapshot(productsCollectionRef, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
            });
        };

        window.addToCart = (productId) => {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                // Ensure only necessary properties are added to the cart
                const { id, name, price, image } = product;
                cart.push({ id, name, price, image, quantity: 1 });
            }
            renderCart();
            window.showAddToCartModal();
        };

        window.removeFromCart = (productId) => {
            const existingItemIndex = cart.findIndex(item => item.id === productId);
            if (existingItemIndex > -1) {
                if (cart[existingItemIndex].quantity > 1) {
                    cart[existingItemIndex].quantity -= 1;
                } else {
                    cart.splice(existingItemIndex, 1);
                }
            }
            renderCart();
        };
        
        async function placeOrder(event) {
            event.preventDefault();

            if (!userId) {
                window.showMessageModal('Please sign in to place an order.');
                return;
            }

            const name = document.getElementById('checkout-name').value;
            const email = document.getElementById('checkout-email').value;
            const address = document.getElementById('checkout-address').value;
            const country = document.getElementById('checkout-country').value;
            const state = document.getElementById('checkout-state').value;

            if (!name || !email || !address || !country) {
                window.showMessageModal('Please fill out all required fields.');
                return;
            }

            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            // FIX: Create a cleaned up items array without 'colors' and 'sizes' properties
            // The previous code was setting these to 'undefined', which Firestore rejects.
            const cleanedCartItems = cart.map(item => {
                const newItem = { ...item };
                delete newItem.colors;
                delete newItem.sizes;
                return newItem;
            });

            // Save order to the user's private collection
            try {
                const userOrdersCollection = collection(db, 'artifacts', app_id, 'users', userId, 'orders');
                const newOrderRef = await addDoc(userOrdersCollection, {
                    items: cleanedCartItems,
                    total: total,
                    name: name,
                    email: email,
                    address: address,
                    country: country,
                    state: state,
                    status: 'Processing',
                    timestamp: serverTimestamp()
                });

                // For the admin panel, save a cleaned up version of the order
                const allOrdersCollection = collection(db, 'artifacts', app_id, 'public', 'data', 'all_orders');
                await setDoc(doc(allOrdersCollection, newOrderRef.id), {
                    userId: userId,
                    items: cleanedCartItems,
                    total: total,
                    name: name,
                    email: email,
                    address: address,
                    country: country,
                    state: state,
                    status: 'Processing',
                    timestamp: serverTimestamp()
                });

                cart = [];
                renderCart();
                closeCheckoutModal();
                window.showMessageModal('Your order has been placed successfully!', 'Order Confirmed');

            } catch (error) {
                console.error("Error placing order:", error);
                window.showMessageModal("Failed to place order. Please try again.");
            }
        }

        const addProduct = async (event) => {
            event.preventDefault();

            const newProduct = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value),
                image: document.getElementById('product-image').value,
                colors: document.getElementById('product-colors').value.split(',').map(s => s.trim()).filter(s => s),
                sizes: document.getElementById('product-sizes').value.split(',').map(s => s.trim()).filter(s => s),
                created: serverTimestamp()
            };

            const productsCollection = collection(db, 'artifacts', app_id, 'public', 'data', 'products');
            await addDoc(productsCollection, newProduct);

            // Clear the form
            addProductForm.reset();
        };

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userProfile.classList.remove('hidden');
                authButtons.classList.add('hidden');
                userAvatar.src = user.photoURL || 'https://placehold.co/40x40';
                userName.textContent = user.displayName || 'User';

                // Check for admin role
                const adminDocRef = doc(db, 'artifacts', app_id, 'public', 'data', 'admins', userId);
                const adminDoc = await getDoc(adminDocRef);
                if (adminDoc.exists()) {
                    adminButton.classList.remove('hidden');
                } else {
                    adminButton.classList.add('hidden');
                }

                // Listen for user-specific orders
                const userOrdersCollection = collection(db, 'artifacts', app_id, 'users', userId, 'orders');
                onSnapshot(userOrdersCollection, (snapshot) => {
                    const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderOrders(orders, myOrdersList);
                });

            } else {
                userId = null;
                userProfile.classList.add('hidden');
                authButtons.classList.remove('hidden');
                adminButton.classList.add('hidden');
                window.showView('products-view');
            }
        });

        // Initial setup
        window.onload = async () => {
            // Sign in with custom token if available
            try {
                if (__initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error signing in:", error);
            }

            // Fetch initial data
            fetchProducts();

            // Listen for all orders for the admin view
            const allOrdersCollection = collection(db, 'artifacts', app_id, 'public', 'data', 'all_orders');
            onSnapshot(allOrdersCollection, (snapshot) => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrders(orders, allOrdersList);
            });

            // Event Listeners
            document.getElementById('cart-button').addEventListener('click', openCartModal);
            document.getElementById('close-modal-button').addEventListener('click', closeCartModal);
            document.getElementById('checkout-button').addEventListener('click', openCheckoutModal);
            document.getElementById('close-checkout-modal').addEventListener('click', closeCheckoutModal);
            checkoutForm.addEventListener('submit', placeOrder);
            loginButton.addEventListener('click', signInWithGoogle);
            signoutLink.addEventListener('click', handleSignOut);
            viewOrdersLink.addEventListener('click', (e) => {
                e.preventDefault();
                profileDropdown.classList.add('hidden');
                window.showView('orders-view');
            });
            userProfileButton.addEventListener('click', () => {
                profileDropdown.classList.toggle('hidden');
            });
            document.getElementById('close-message-modal').addEventListener('click', window.closeMessageModal);
            document.getElementById('acknowledge-button').addEventListener('click', window.closeAddToCartModal);
            document.getElementById('close-options-modal').addEventListener('click', window.closeAddToCartModal);

            // Admin panel events
            adminButton.addEventListener('click', () => window.showView('admin-view'));
            addProductForm.addEventListener('submit', addProduct);

            window.showView('products-view');
        };

    </script>
</body>
</html>
