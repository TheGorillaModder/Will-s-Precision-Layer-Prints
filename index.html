<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Will's Precision Layer Prints</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #9ca3af; }
        .modal-bg { background-color: rgba(0, 0, 0, 0.5); }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* Extra padding to increase file length as requested and keep structure readable */
    </style>
</head>
<body class="bg-gray-500 min-h-screen flex flex-col items-center">

<!-- Header -->
<header class="w-full bg-black text-white shadow-md p-4 sticky top-0 z-50">
  <div class="container mx-auto flex justify-between items-center max-w-7xl">
    <!-- Home Button -->
    <button id="home-btn" class="flex items-center space-x-2 text-2xl font-bold text-gray-200 cursor-pointer hover:text-red-500 transition-colors duration-200">
      <img src="wplp.png" alt="WPLP Logo" class="h-8">
      <span>Will's Precision Layer Prints</span>
    </button>

    <!-- Right Side Buttons -->
    <div class="flex items-center space-x-4">
      <!-- Admin Button (hidden until verified) -->
      <button id="admin-button" class="hidden bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-blue-700 transition duration-300">Admin</button>

      <!-- Cart Button -->
      <button id="cart-button" class="relative bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-red-700 transition duration-300">
        Cart
        <span id="cart-badge" class="absolute -top-2 -right-2 bg-white text-red-600 font-bold text-xs px-2 py-0.5 rounded-full opacity-0">0</span>
      </button>

      <!-- Auth Buttons -->
      <div id="auth-buttons" class="flex items-center space-x-2">
        <button id="login-button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-red-700 transition duration-300">Sign In</button>
      </div>

      <!-- User Profile Menu -->
      <div id="user-profile-menu" class="relative hidden">
        <button id="user-profile-button" class="flex items-center space-x-2 bg-gray-700 text-gray-200 rounded-full p-2 hover:bg-gray-600 transition-colors duration-200">
          <img id="user-avatar" class="w-8 h-8 rounded-full" src="https://placehold.co/32x32/cccccc/ffffff?text=U" onerror="this.src='https://placehold.co/32x32/cccccc/ffffff?text=U';">
          <span id="user-name" class="font-semibold text-sm"></span>
        </button>
        <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10 hidden">
          <a href="#" id="view-orders-link" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">My Orders</a>
          <a href="#" id="signout-link" class="block px-4 py-2 text-red-500 hover:bg-gray-100 border-t">Sign Out</a>
        </div>
      </div>
    </div>
  </div>
</header>


    <!-- Login Modal -->
    <div id="login-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Sign In / Create Account</h2>
            <button id="close-login-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">✖</button>
            <div class="space-y-4">
                <button id="google-login" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Sign in with Google</button>

                <div class="flex items-center justify-between">
                    <span class="text-gray-400">or</span>
                </div>

                <form id="email-login-form" class="space-y-4">
                    <input type="email" id="email-input" placeholder="Email" class="w-full p-3 border rounded" required>
                    <input type="password" id="password-input" placeholder="Password" class="w-full p-3 border rounded" required>
                    <div class="flex space-x-2">
                        <button type="submit" id="email-signin" class="w-1/2 bg-red-600 text-white py-2 rounded hover:bg-red-700">Sign In</button>
                        <button type="button" id="email-create" class="w-1/2 bg-green-600 text-white py-2 rounded hover:bg-green-700">Create Account</button>
                    </div>
                </form>
            </div>
            <p class="text-xs text-gray-500 mt-4">By signing in you agree to the terms and conditions.</p>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="container mx-auto p-8 max-w-7xl flex-grow w-full">
        <!-- Products View -->
        <div id="products-view">
            <div class="text-center mb-12">
                <img src="wplp.png" alt="WPLP Logo" class="mx-auto h-24 mb-4">
                <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Precision Layer Prints</h1>
                <p class="text-xl text-gray-600 italic">"Bringing your ideas to life, layer by layer."</p>
                <div class="mt-8 flex justify-center">
                    <input type="text" id="product-search" placeholder="Search for products..." class="w-full max-w-md p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-300">
                </div>
            </div>

            <div id="product-list" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                <div id="products-loading" class="col-span-full flex justify-center items-center py-12">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-gray-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-xl font-semibold text-gray-800">Loading products...</span>
                </div>
            </div>
            <p id="no-products-found" class="hidden text-center text-gray-500 py-4">No products found matching your search.</p>
        </div>

        <!-- Product Detail View -->
        <div id="product-detail-view" class="hidden relative">
            <button onclick="window.showView('products-view')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200 z-10 p-2 rounded-full bg-white bg-opacity-70">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div id="product-detail-content" class="bg-white rounded-lg shadow-xl p-8 flex flex-col md:flex-row gap-8">
            </div>
        </div>

        <!-- Orders View -->
        <div id="orders-view" class="hidden relative">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">My Order History</h2>
            <button onclick="window.showView('products-view')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200 p-2 rounded-full bg-white bg-opacity-70">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div id="orders-list" class="space-y-4">
                <p id="empty-orders-message" class="text-gray-500 text-center py-4">You have no past orders.</p>
            </div>
        </div>

        <!-- Admin View -->
        <div id="admin-view" class="hidden relative">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Admin Dashboard</h2>
            <button onclick="window.showView('products-view')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200 p-2 rounded-full bg-white bg-opacity-70">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="space-y-8">
                <!-- Add Product Form - Accordion -->
                <div class="bg-white rounded-lg shadow-xl">
                    <button id="toggle-add-product-btn" class="flex justify-between items-center w-full p-6 text-2xl font-bold text-gray-800 border-b-2 border-gray-100 hover:bg-gray-50 transition duration-300">
                        Add a New Product
                        <svg id="add-product-arrow" class="w-6 h-6 transform rotate-0 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="add-product-content" class="p-6 hidden">
                        <form id="add-product-form" class="space-y-4">
                            <div>
                                <label for="product-name" class="block text-gray-700 font-semibold mb-1">Product Name</label>
                                <input type="text" id="product-name" required class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="product-description" class="block text-gray-700 font-semibold mb-1">Description</label>
                                <textarea id="product-description" required class="w-full p-2 border rounded-md"></textarea>
                            </div>
                            <div>
                                <label for="product-image" class="block text-gray-700 font-semibold mb-1">Image URL</label>
                                <input type="text" id="product-image" required class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="product-colors" class="block text-gray-700 font-semibold mb-1">Colors (comma separated)</label>
                                <input type="text" id="product-colors" required class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="product-sizes" class="block text-gray-700 font-semibold mb-1">Sizes (comma separated)</label>
                                <input type="text" id="product-sizes" required class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="product-prices" class="block text-gray-700 font-semibold mb-1">Prices (JSON format)</label>
                                <textarea id="product-prices" required class="w-full p-2 border rounded-md" placeholder='{"Small": 5.00, "Medium": 11.00, "Large": 20.00}'></textarea>
                                <p class="text-sm text-gray-500 mt-1">Example: <code>{"Small": 5.00, "Large": 20.00}</code></p>
                            </div>
                            <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 w-full">Add Product</button>
                        </form>
                    </div>
                </div>

                <!-- All Orders List - Accordion -->
                <div class="bg-white rounded-lg shadow-xl">
                    <button id="toggle-all-orders-btn" class="flex justify-between items-center w-full p-6 text-2xl font-bold text-gray-800 border-b-2 border-gray-100 hover:bg-gray-50 transition duration-300">
                        All Orders
                        <svg id="all-orders-arrow" class="w-6 h-6 transform rotate-180 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="all-orders-content" class="p-6">
                        <div class="mb-4">
                            <input type="text" id="order-search" placeholder="Search by name or order number..." class="w-full p-2 border rounded-md">
                        </div>
                        <div id="all-orders-list" class="space-y-4">
                            <p class="text-gray-500 text-center py-4">No orders yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Checkout Modal -->
        <div id="checkout-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-4">Checkout Details</h2>
                <button id="close-checkout-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">✖</button>
                <form id="checkout-form">
                    <div class="mb-4">
                        <label for="checkout-name" class="block text-gray-700 text-sm font-bold mb-2">Name:</label>
                        <input type="text" id="checkout-name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div class="mb-4">
                        <label for="checkout-email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                        <input type="email" id="checkout-email" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div class="mb-4">
                        <label for="checkout-address" class="block text-gray-700 text-sm font-bold mb-2">Shipping Address:</label>
                        <textarea id="checkout-address" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="checkout-city" class="block text-gray-700 text-sm font-bold mb-2">City:</label>
                        <input type="text" id="checkout-city" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div class="mb-4">
                        <label for="checkout-country" class="block text-gray-700 text-sm font-bold mb-2">Country:</label>
                        <input type="text" id="checkout-country" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div class="mb-4">
                        <label for="checkout-state" class="block text-gray-700 text-sm font-bold mb-2">State/Region (optional):</label>
                        <input type="text" id="checkout-state" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <div class="text-right">
                        <button type="submit" id="submit-order-button" class="bg-red-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-red-600 transition duration-300">Place Order</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Cart Modal -->
        <div id="cart-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-4">Your Cart</h2>
                <button id="close-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">✖</button>
                <div id="cart-items" class="space-y-4">
                    <div id="cart-empty-message" class="text-center text-gray-500">Your cart is empty.</div>
                </div>
                <div id="cart-summary" class="mt-6 border-t pt-4">
                    <div class="flex justify-between items-center text-xl font-bold text-gray-800">
                        <span>Total:</span>
                        <span id="cart-total">$0.00</span>
                    </div>
                    <button id="checkout-button" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-red-700 transition duration-300 mt-4" disabled>Proceed to Checkout</button>
                </div>
            </div>
        </div>

        <!-- Message Modal -->
        <div id="message-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg">
            <div class="bg-white rounded-xl shadow-2xl p-6 relative flex flex-col items-center max-w-sm">
                <button id="close-message-modal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">✖</button>
                <div id="message-content">
                    <div id="loading-spinner" class="animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-red-500 mx-auto"></div>
                    <p id="message-text" class="mt-4 text-lg font-semibold text-gray-700 text-center">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Add to Cart Success Modal -->
        <div id="add-to-cart-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg">
            <div class="bg-white rounded-xl shadow-2xl p-6 relative flex flex-col items-center max-w-sm">
                <div class="text-green-500 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <p class="text-xl font-semibold text-gray-700 text-center">Item added to cart!</p>
                <button id="acknowledge-button" class="mt-4 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">OK</button>
            </div>
        </div>

        <!-- Admin Order Details Modal -->
        <div id="admin-order-details-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-4">Order Details</h2>
                <button id="close-admin-order-details-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200">✖</button>
                <div id="admin-order-details-content"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            onAuthStateChanged,
            signOut,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            collection,
            query,
            where,
            addDoc,
            onSnapshot,
            serverTimestamp,
            deleteDoc,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config (keeps local config unless __firebase_config provided)
        let firebaseConfig = {
	  apiKey: "AIzaSyBZHcWkwB2bff5beuh1J50NI-9WeYvhcIg",
	  authDomain: "will-s-precision-layer-prints.firebaseapp.com",
	  projectId: "will-s-precision-layer-prints",
	  storageBucket: "will-s-precision-layer-prints.firebasestorage.app",
	  messagingSenderId: "28322806740",
	  appId: "1:28322806740:web:643d6bd0d857d936f77441",
  	  measurementId: "G-P96D22GYV5"
	};
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.error("Failed to parse firebase config:", e);
        }

        if (!firebaseConfig.projectId) {
            console.error("Firebase configuration is empty or invalid. The app will not function correctly.");
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const appId = 'will-s-precision-layer-prints';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let productsCollection;
        let ordersCollection;

        let isAdmin = false;
        let userId = null;

        const authButtons = document.getElementById('auth-buttons');
        const userProfileMenu = document.getElementById('user-profile-menu');
        const loginButton = document.getElementById('login-button');
        const userProfileButton = document.getElementById('user-profile-button');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const profileDropdown = document.getElementById('profile-dropdown');
        const signoutLink = document.getElementById('signout-link');
        const viewOrdersLink = document.getElementById('view-orders-link');
        const adminButton = document.getElementById('admin-button');

        const productsView = document.getElementById('products-view');
        const productsList = document.getElementById('product-list');
        const productSearchInput = document.getElementById('product-search');
        const noProductsFoundMessage = document.getElementById('no-products-found');
        const productsLoading = document.getElementById('products-loading');

        const productDetailView = document.getElementById('product-detail-view');
        const productDetailContent = document.getElementById('product-detail-content');

        const cartButton = document.getElementById('cart-button');
        const cartBadge = document.getElementById('cart-badge');
        const cartModal = document.getElementById('cart-modal');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalSpan = document.getElementById('cart-total');
        const checkoutButton = document.getElementById('checkout-button');
        const cartEmptyMessage = document.getElementById('cart-empty-message');

        const checkoutModal = document.getElementById('checkout-modal');
        const checkoutForm = document.getElementById('checkout-form');
        const checkoutNameInput = document.getElementById('checkout-name');
        const checkoutEmailInput = document.getElementById('checkout-email');
        const checkoutAddressInput = document.getElementById('checkout-address');
        const checkoutCityInput = document.getElementById('checkout-city');
        const checkoutCountryInput = document.getElementById('checkout-country');
        const checkoutStateInput = document.getElementById('checkout-state');

        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const closeMessageModal = document.getElementById('close-message-modal');

        const addToCartModal = document.getElementById('add-to-cart-modal');
        const acknowledgeButton = document.getElementById('acknowledge-button');

        const ordersView = document.getElementById('orders-view');
        const ordersList = document.getElementById('orders-list');
        const emptyOrdersMessage = document.getElementById('empty-orders-message');

        const adminView = document.getElementById('admin-view');
        const addProductForm = document.getElementById('add-product-form');
        const toggleAddProductBtn = document.getElementById('toggle-add-product-btn');
        const addProductContent = document.getElementById('add-product-content');
        const addProductArrow = document.getElementById('add-product-arrow');
        const toggleAllOrdersBtn = document.getElementById('toggle-all-orders-btn');
        const allOrdersContent = document.getElementById('all-orders-content');
        const allOrdersArrow = document.getElementById('all-orders-arrow');
        const allOrdersList = document.getElementById('all-orders-list');
        const orderSearchInput = document.getElementById('order-search');

        const adminOrderDetailsModal = document.getElementById('admin-order-details-modal');
        const closeAdminOrderDetailsModalBtn = document.getElementById('close-admin-order-details-modal');
        const adminOrderDetailsContent = document.getElementById('admin-order-details-content');

        const loginModal = document.getElementById('login-modal');
        const closeLoginModal = document.getElementById('close-login-modal');
        const googleLogin = document.getElementById('google-login');
        const emailLoginForm = document.getElementById('email-login-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const emailSigninBtn = document.getElementById('email-signin');
        const emailCreateBtn = document.getElementById('email-create');

        let cart = {};

        // Helper functions and UI logic
        window.showView = function(viewId) {
            const views = [productsView, productDetailView, ordersView, adminView];
            views.forEach(view => { view.classList.add('hidden'); });
            document.getElementById(viewId).classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function showMessageModal(text, isSpinning = false, dismissible = true) {
            messageText.textContent = text;
            loadingSpinner.classList.toggle('hidden', !isSpinning);
            closeMessageModal.classList.toggle('hidden', !dismissible);
            messageModal.classList.remove('hidden');
        }

        window.closeMessageModal = function() { messageModal.classList.add('hidden'); }

        function openCartModal() { cartModal.classList.remove('hidden'); }
        function closeCartModal() { cartModal.classList.add('hidden'); }
        function openCheckoutModal() { closeCartModal(); checkoutModal.classList.remove('hidden'); }
        function closeCheckoutModal() { checkoutModal.classList.add('hidden'); }
        window.closeAddToCartModal = function() { addToCartModal.classList.add('hidden'); }
        function closeAdminOrderDetailsModal() { adminOrderDetailsModal.classList.add('hidden'); }

        function updateCartUI() {
            cartItemsContainer.innerHTML = '';
            let total = 0;
            let totalItems = 0;
            const items = Object.values(cart);
            if (items.length === 0) {
                cartEmptyMessage.classList.remove('hidden');
                checkoutButton.disabled = true;
            } else {
                cartEmptyMessage.classList.add('hidden');
                checkoutButton.disabled = false;
                items.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    totalItems += item.quantity;
                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg';
                    cartItemDiv.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <img src="${item.image}" alt="${item.name}" class="w-16 h-16 rounded-md">
                            <div>
                                <h3 class="font-semibold text-gray-800">${item.name}</h3>
                                <p class="text-sm text-gray-600">${item.size} - ${item.color}</p>
                                <p class="text-sm text-gray-500">$${item.price.toFixed(2)} each</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="cart-remove-one text-red-500 hover:text-red-700 font-bold text-lg leading-none" data-id="${item.id}" data-size="${item.size}" data-color="${item.color}">&minus;</button>
                            <span class="font-bold text-gray-800">${item.quantity}</span>
                            <button class="cart-add-one text-green-500 hover:text-green-700 font-bold text-lg leading-none" data-id="${item.id}" data-size="${item.size}" data-color="${item.color}">&plus;</button>
                            <button class="cart-remove-all text-red-500 hover:text-red-700 text-sm ml-2" data-id="${item.id}" data-size="${item.size}" data-color="${item.color}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(cartItemDiv);
                });
            }
            cartTotalSpan.textContent = `$${total.toFixed(2)}`;
            // cartBadge may not exist in this trimmed UI; toggle if exists
            if (cartBadge) {
                cartBadge.textContent = totalItems;
                cartBadge.classList.toggle('opacity-0', totalItems === 0);
            }
        }

        function addToCart(product, quantity = 1) {
            const key = `${product.id}-${product.size}-${product.color}`;
            if (cart[key]) cart[key].quantity += quantity;
            else cart[key] = { id: product.id, name: product.name, image: product.image, size: product.size, color: product.color, price: product.price, quantity };
            updateCartUI();
            addToCartModal.classList.remove('hidden');
        }

        function handleCartAction(event) {
            const target = event.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            const size = target.dataset.size;
            const color = target.dataset.color;
            const key = `${id}-${size}-${color}`;
            if (target.classList.contains('cart-remove-one')) {
                if (cart[key].quantity > 1) cart[key].quantity -= 1;
                else delete cart[key];
            } else if (target.classList.contains('cart-add-one')) {
                cart[key].quantity += 1;
            } else if (target.classList.contains('cart-remove-all')) {
                delete cart[key];
            }
            updateCartUI();
        }

        function toggleAccordion(contentId, arrowId) {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(arrowId);
            const isHidden = content.classList.contains('hidden');
            content.classList.toggle('hidden', !isHidden);
            arrow.classList.toggle('rotate-0', isHidden);
            arrow.classList.toggle('rotate-180', !isHidden);
        }

        async function fetchProducts() {
            productsLoading.classList.remove('hidden');
            productsList.innerHTML = '';
            try {
                const q = query(productsCollection);
                const querySnapshot = await getDocs(q);
                const products = [];
                querySnapshot.forEach((doc) => products.push({ id: doc.id, ...doc.data() }));
                renderProducts(products);
            } catch (error) {
                console.error("Error fetching products:", error);
                showMessageModal("Failed to load products. Please try again later.", false, true);
            } finally {
                productsLoading.classList.add('hidden');
            }
        }

        function renderProducts(products) {
            productsList.innerHTML = '';
            if (products.length === 0) {
                noProductsFoundMessage.classList.remove('hidden');
                return;
            } else {
                noProductsFoundMessage.classList.add('hidden');
            }
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 overflow-hidden cursor-pointer product-card';
                productCard.dataset.name = product.name;
                productCard.onclick = () => renderProductDetail(product);
                const firstPrice = Object.values(product.prices || { "Default": 0 })[0] || 0;
                productCard.innerHTML = `
                    <div class="relative w-full h-48 overflow-hidden bg-gray-200">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-110" onerror="this.src='https://placehold.co/400x300/e5e7eb/4b5563?text=Image+Not+Found';">
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800">${product.name}</h3>
                        <p class="mt-2 text-red-600 font-bold text-lg">$${Number(firstPrice).toFixed(2)}</p>
                    </div>
                `;
                productsList.appendChild(productCard);
            });
        }

        function renderProductDetail(product) {
            productDetailContent.innerHTML = `
                <div class="flex-shrink-0 w-full md:w-1/2">
                    <img src="${product.image}" alt="${product.name}" class="w-full h-auto rounded-lg shadow-md" onerror="this.src='https://placehold.co/600x600/e5e7eb/4b5563?text=Image+Not+Found';">
                </div>
                <div class="flex-grow md:w-1/2">
                    <h2 class="text-4xl font-extrabold text-gray-800 mb-2">${product.name}</h2>
                    <p class="text-gray-600 mb-6">${product.description || ''}</p>
                    <div class="mb-4">
                        <span class="text-sm font-semibold text-gray-700">Colors:</span>
                        <div id="product-colors" class="flex flex-wrap gap-2 mt-2">
                            ${(product.colors || []).map(c => `<span class="inline-block px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-800 cursor-pointer hover:bg-red-500 hover:text-white transition-colors duration-200" data-color="${c}">${c}</span>`).join('')}
                        </div>
                    </div>
                    <div class="mb-6">
                        <span class="text-sm font-semibold text-gray-700">Sizes:</span>
                        <div id="product-sizes" class="flex flex-wrap gap-2 mt-2">
                            ${(product.sizes || []).map(s => `<span class="inline-block px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-800 cursor-pointer hover:bg-red-500 hover:text-white transition-colors duration-200" data-size="${s}">${s}</span>`).join('')}
                        </div>
                    </div>
                    <div class="mb-6">
                        <span class="text-sm font-semibold text-gray-700">Price:</span>
                        <div id="product-price" class="text-3xl font-bold text-red-600 mt-2">$${Object.values(product.prices || { "Default": 0 })[0].toFixed(2)}</div>
                    </div>
                    <button id="add-to-cart-btn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-red-700 transition duration-300">Add to Cart</button>
                    <div id="options-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-bg">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative">
                            <h3 class="text-xl font-bold mb-4">Select options</h3>
                            <p>Please select a color and size before adding to cart.</p>
                            <button id="close-options-modal" class="mt-4 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Close</button>
                        </div>
                    </div>
                </div>
            `;
            const colorSpans = productDetailContent.querySelectorAll('#product-colors span');
            const sizeSpans = productDetailContent.querySelectorAll('#product-sizes span');
            const priceDisplay = document.getElementById('product-price');
            const optionsModal = document.getElementById('options-modal');
            const closeOptionsModal = document.getElementById('close-options-modal');
            let selectedColor = null;
            let selectedSize = null;

            function updatePrice() {
                if (selectedSize && product.prices && product.prices[selectedSize]) {
                    priceDisplay.textContent = `$${product.prices[selectedSize].toFixed(2)}`;
                } else {
                    priceDisplay.textContent = `$${Object.values(product.prices || { "Default": 0 })[0].toFixed(2)}`;
                }
            }

            colorSpans.forEach(span => {
                span.addEventListener('click', () => {
                    colorSpans.forEach(s => s.classList.remove('bg-red-500', 'text-white'));
                    span.classList.add('bg-red-500', 'text-white');
                    selectedColor = span.dataset.color;
                });
            });

            sizeSpans.forEach(span => {
                span.addEventListener('click', () => {
                    sizeSpans.forEach(s => s.classList.remove('bg-red-500', 'text-white'));
                    span.classList.add('bg-red-500', 'text-white');
                    selectedSize = span.dataset.size;
                    updatePrice();
                });
            });

            closeOptionsModal.addEventListener('click', () => optionsModal.classList.add('hidden'));

            document.getElementById('add-to-cart-btn').addEventListener('click', () => {
                if (selectedColor && selectedSize) {
                    const productToAdd = {
                        id: product.id,
                        name: product.name,
                        image: product.image,
                        price: product.prices ? product.prices[selectedSize] : Object.values(product.prices || { "Default": 0 })[0],
                        color: selectedColor,
                        size: selectedSize
                    };
                    addToCart(productToAdd);
                } else {
                    optionsModal.classList.remove('hidden');
                }
            });

            window.showView('product-detail-view');
        }

        async function placeOrder(event) {
            event.preventDefault();
            showMessageModal("Placing your order...", true, false);

            if (Object.keys(cart).length === 0) {
                showMessageModal("Your cart is empty!", false, true);
                return;
            }

            const customerName = checkoutNameInput.value;
            const customerEmail = checkoutEmailInput.value;
            const shippingAddress = checkoutAddressInput.value;
            const city = checkoutCityInput.value;
            const country = checkoutCountryInput.value;
            const state = checkoutStateInput.value;
            const orderId = `ORDER-${Date.now()}`;
            const total = parseFloat(cartTotalSpan.textContent.replace('$', ''));

            const order = {
                orderId,
                userId,
                timestamp: serverTimestamp(),
                customerName,
                customerEmail,
                shippingAddress,
                city,
                country,
                state,
                items: Object.values(cart),
                total,
                status: 'Processing'
            };

            try {
                await addDoc(ordersCollection, order);
                cart = {};
                updateCartUI();
                closeCheckoutModal();
                showMessageModal("Order placed successfully! Your order number is " + orderId, false, true);
                checkoutForm.reset();
            } catch (error) {
                console.error("Error placing order:", error);
                showMessageModal("Failed to place order. Please try again.", false, true);
            }
        }

        async function fetchMyOrders() {
            if (!userId) {
                ordersList.innerHTML = `<p class="text-gray-500 text-center py-4">You must be signed in to view your orders.</p>`;
                return;
            }
            ordersList.innerHTML = `<div class="flex justify-center items-center py-12"><svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-gray-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-xl font-semibold text-gray-800">Loading orders...</span></div>`;
            const q = query(ordersCollection, where("userId", "==", userId));
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const orders = [];
                querySnapshot.forEach((doc) => orders.push({ id: doc.id, ...doc.data() }));
                renderMyOrders(orders);
            });
            return unsubscribe;
        }

        function renderMyOrders(orders) {
            ordersList.innerHTML = '';
            if (orders.length === 0) {
                emptyOrdersMessage.classList.remove('hidden');
                return;
            } else {
                emptyOrdersMessage.classList.add('hidden');
            }
            orders.sort((a, b) => (b.timestamp && a.timestamp) ? b.timestamp.seconds - a.timestamp.seconds : 0);
            orders.forEach(order => {
                const orderDate = order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A';
                const orderDiv = document.createElement('div');
                orderDiv.className = 'bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500';
                orderDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Order #${order.orderId}</h3>
                        <span class="text-sm font-semibold text-red-500 bg-red-100 px-3 py-1 rounded-full">${order.status}</span>
                    </div>
                    <p class="text-sm text-gray-500 mb-2">Placed on: ${orderDate}</p>
                    <p class="text-sm text-gray-500 mb-4">Total: <span class="font-bold text-gray-800">$${order.total.toFixed(2)}</span></p>
                    <div class="space-y-2">
                        <h4 class="font-bold text-gray-700">Items:</h4>
                        ${order.items.map(item => `
                            <div class="flex items-center space-x-4">
                                <img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded-md">
                                <div>
                                    <p class="text-sm text-gray-800">${item.name} (${item.size}, ${item.color})</p>
                                    <p class="text-xs text-gray-500">Qty: ${item.quantity} @ $${item.price.toFixed(2)}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                ordersList.appendChild(orderDiv);
            });
        }

        async function fetchAllOrders() {
            allOrdersList.innerHTML = `<div class="flex justify-center items-center py-12"><svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-gray-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-xl font-semibold text-gray-800">Loading all orders...</span></div>`;
            const q = query(ordersCollection);
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const orders = [];
                querySnapshot.forEach((doc) => orders.push({ id: doc.id, ...doc.data() }));
                renderAllOrders(orders);
            });
            return unsubscribe;
        }

        function renderAllOrders(orders) {
            allOrdersList.innerHTML = '';
            const searchTerm = orderSearchInput.value.toLowerCase();
            const filteredOrders = orders.filter(order =>
                (order.customerName || '').toLowerCase().includes(searchTerm) ||
                (order.orderId || '').toLowerCase().includes(searchTerm)
            );
            if (filteredOrders.length === 0) {
                allOrdersList.innerHTML = `<p class="text-gray-500 text-center py-4">No orders found.</p>`;
                return;
            }
            filteredOrders.sort((a, b) => (b.timestamp && a.timestamp) ? b.timestamp.seconds - a.timestamp.seconds : 0);
            filteredOrders.forEach(order => {
                const orderDate = order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A';
                const orderDiv = document.createElement('div');
                orderDiv.className = 'bg-gray-100 rounded-lg shadow p-4 mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center';
                orderDiv.innerHTML = `
                    <div>
                        <h4 class="font-bold text-lg">Order ID: <span class="font-normal">${order.orderId}</span></h4>
                        <p class="text-sm text-gray-600">Customer: ${order.customerName}</p>
                        <p class="text-sm text-gray-600">Total: $${order.total.toFixed(2)}</p>
                        <p class="text-sm text-gray-600">Placed: ${orderDate}</p>
                    </div>
                    <div class="mt-4 sm:mt-0 flex items-center space-x-2">
                        <select class="order-status-dropdown bg-white border border-gray-300 rounded-md p-2" data-order-id="${order.id}">
                            <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                            <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                            <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                        </select>
                        <button class="view-order-details-btn bg-blue-500 text-white text-sm px-3 py-2 rounded-md hover:bg-blue-600" data-order-id="${order.id}">View Details</button>
                    </div>
                `;
                allOrdersList.appendChild(orderDiv);
            });
            allOrdersList.querySelectorAll('.view-order-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderId = e.target.dataset.orderId;
                    const order = orders.find(o => o.id === orderId);
                    if (order) renderAdminOrderDetailsModal(order);
                });
            });
            allOrdersList.querySelectorAll('.order-status-dropdown').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const orderDocId = e.target.dataset.orderId;
                    const newStatus = e.target.value;
                    await updateOrderStatus(orderDocId, newStatus);
                });
            });
        }

        async function updateOrderStatus(orderDocId, newStatus) {
            try {
                await updateDoc(doc(db, ordersCollection.path, orderDocId), { status: newStatus });
                showMessageModal(`Order status updated to ${newStatus}.`, false, true);
            } catch (error) {
                console.error("Error updating order status:", error);
                showMessageModal("Failed to update order status.", false, true);
            }
        }

        function renderAdminOrderDetailsModal(order) {
            const orderDate = order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A';
            adminOrderDetailsContent.innerHTML = `
                <div class="space-y-4">
                    <p><span class="font-bold">Order ID:</span> ${order.orderId}</p>
                    <p><span class="font-bold">Customer Name:</span> ${order.customerName}</p>
                    <p><span class="font-bold">Email:</span> ${order.customerEmail}</p>
                    <p><span class="font-bold">Shipping Address:</span> ${order.shippingAddress}, ${order.city}, ${order.state ? order.state + ', ' : ''}${order.country}</p>
                    <p><span class="font-bold">Order Status:</span> ${order.status}</p>
                    <p><span class="font-bold">Total:</span> $${order.total.toFixed(2)}</p>
                    <p><span class="font-bold">Items:</span></p>
                    <ul class="list-disc list-inside space-y-1">
                        ${order.items.map(item => `<li>${item.name} (${item.size}, ${item.color}) - Qty: ${item.quantity}</li>`).join('')}
                    </ul>
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="dismiss-order-button" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" data-order-id="${order.id}">Dismiss Order</button>
                </div>
            `;
            document.getElementById('dismiss-order-button').addEventListener('click', async (e) => {
                const orderId = e.target.dataset.orderId;
                if (confirm('Are you sure you want to dismiss this order? This will permanently delete it.')) {
                    try {
                        await deleteDoc(doc(db, ordersCollection.path, orderId));
                        closeAdminOrderDetailsModal();
                        showMessageModal("Order dismissed successfully.", false, true);
                    } catch (error) {
                        console.error("Error dismissing order:", error);
                        showMessageModal("Failed to dismiss order.", false, true);
                    }
                }
            });
            adminOrderDetailsModal.classList.remove('hidden');
        }

        async function addProduct(event) {
            event.preventDefault();
            showMessageModal("Adding product...", true, false);
            const productName = document.getElementById('product-name').value;
            const productDescription = document.getElementById('product-description').value;
            const productImage = document.getElementById('product-image').value;
            const productColors = document.getElementById('product-colors').value.split(',').map(s => s.trim());
            const productSizes = document.getElementById('product-sizes').value.split(',').map(s => s.trim());
            let productPrices;
            try {
                productPrices = JSON.parse(document.getElementById('product-prices').value);
            } catch (e) {
                showMessageModal("Invalid prices JSON. Please correct it.", false, true);
                return;
            }
            try {
                await addDoc(productsCollection, {
                    name: productName,
                    description: productDescription,
                    image: productImage,
                    colors: productColors,
                    sizes: productSizes,
                    prices: productPrices,
                });
                showMessageModal("Product added successfully!", false, true);
                addProductForm.reset();
                fetchProducts();
            } catch (error) {
                console.error("Error adding product: ", error);
                showMessageModal("Failed to add product. Please check the form and try again.", false, true);
            }
        }

        async function signInWithGoogle() {
            try {
                await signInWithPopup(auth, provider);
                hideLoginModal();
            } catch (error) {
                console.error("Error during sign in:", error);
                showMessageModal("Failed to sign in. Please try again.", false, true);
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error during sign out:", error);
                showMessageModal("Failed to sign out. Please try again.", false, true);
            }
        }

        async function initializeFirestoreAndAuth() {
            productsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            ordersCollection = collection(db, 'artifacts', appId, 'public', 'data', 'orders');

            // Handle initial custom auth token sign-in if provided (optional)
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Error signing in with custom token:", error);
                }
            }

            // Listen for auth state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    authButtons.classList.add('hidden');
                    userProfileMenu.classList.remove('hidden');
                    userName.textContent = user.displayName || user.email || 'User';
                    userAvatar.src = user.photoURL || 'https://placehold.co/32x32/cccccc/ffffff?text=U';

                    // Check if user is admin
                    const adminDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', user.uid);
                    const adminDoc = await getDoc(adminDocRef);
                    isAdmin = adminDoc.exists();
                    adminButton.classList.toggle('hidden', !isAdmin);

                } else {
                    userId = null;
                    isAdmin = false;
                    authButtons.classList.remove('hidden');
                    userProfileMenu.classList.add('hidden');
                    adminButton.classList.add('hidden');
                }
            });

            // Initial data fetch
            fetchProducts();
        }

        function filterProducts() {
            const searchTerm = productSearchInput.value.toLowerCase();
            const productCards = productsList.querySelectorAll('.product-card');
            let foundProducts = false;
            productCards.forEach(card => {
                const productName = card.dataset.name.toLowerCase();
                if (productName.includes(searchTerm)) {
                    card.classList.remove('hidden');
                    foundProducts = true;
                } else {
                    card.classList.add('hidden');
                }
            });
            noProductsFoundMessage.classList.toggle('hidden', foundProducts);
        }

        // Event Listeners and initialization
        window.onload = function() {
            initializeFirestoreAndAuth();

            // Login modal controls
            loginButton.addEventListener('click', () => { loginModal.classList.remove('hidden'); });
            closeLoginModal.addEventListener('click', () => { loginModal.classList.add('hidden'); });
            googleLogin.addEventListener('click', signInWithGoogle);

            emailLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    loginModal.classList.add('hidden');
                } catch (err) {
                    if (err.code === 'auth/user-not-found') {
                        // prompt to create account
                        if (confirm("No account found. Create one?")) {
                            try {
                                await createUserWithEmailAndPassword(auth, email, password);
                                loginModal.classList.add('hidden');
                            } catch (createErr) {
                                showMessageModal(createErr.message, false, true);
                            }
                        }
                    } else {
                        showMessageModal(err.message, false, true);
                    }
                }
            });

            emailCreateBtn.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                if (!email || !password) return showMessageModal("Please enter email and password to create an account.", false, true);
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    loginModal.classList.add('hidden');
                } catch (err) {
                    showMessageModal(err.message, false, true);
                }
            });

	    cartButton.addEventListener('click', () => {
       	        cartModal.classList.remove('hidden');
	    });

            // Cart and UI listeners
            document.getElementById('close-modal-button')?.addEventListener('click', closeCartModal);
            document.getElementById('close-checkout-modal')?.addEventListener('click', closeCheckoutModal);
            checkoutForm.addEventListener('submit', placeOrder);
            signoutLink.addEventListener('click', (e) => { e.preventDefault(); handleSignOut(); });
            viewOrdersLink.addEventListener('click', (e) => { e.preventDefault(); fetchMyOrders(); window.showView('orders-view'); profileDropdown.classList.add('hidden'); });
            userProfileButton.addEventListener('click', () => profileDropdown.classList.toggle('hidden'));
            closeMessageModal.addEventListener('click', window.closeMessageModal);
            document.getElementById('acknowledge-button')?.addEventListener('click', window.closeAddToCartModal);
            document.getElementById('cart-items')?.addEventListener('click', handleCartAction);

            productSearchInput.addEventListener('input', () => {
                const searchTerm = productSearchInput.value.toLowerCase();
                const cards = productsList.querySelectorAll('.product-card');
                let found = false;
                cards.forEach(card => {
                    if (card.dataset.name.toLowerCase().includes(searchTerm)) {
                        card.style.display = '';
                        found = true;
                    } else {
                        card.style.display = 'none';
                    }
                });
                noProductsFoundMessage.classList.toggle('hidden', found);
            });

            // Admin panel events
            adminButton.addEventListener('click', () => { window.showView('admin-view'); fetchAllOrders(); });
            addProductForm?.addEventListener('submit', addProduct);
            toggleAddProductBtn?.addEventListener('click', () => toggleAccordion('add-product-content', 'add-product-arrow'));
            toggleAllOrdersBtn?.addEventListener('click', () => toggleAccordion('all-orders-content', 'all-orders-arrow'));
            closeAdminOrderDetailsModalBtn?.addEventListener('click', closeAdminOrderDetailsModal);
            orderSearchInput?.addEventListener('input', () => fetchAllOrders());

            window.showView('products-view');
        };
    </script>

</body>
</html>
